import os
from ament_index_python.packages import get_package_share_directory
from launch import LaunchDescription
from launch.actions import IncludeLaunchDescription, DeclareLaunchArgument
from launch.launch_description_sources import PythonLaunchDescriptionSource
from launch.substitutions import LaunchConfiguration, PathJoinSubstitution
from launch_ros.actions import Node
from launch.conditions import IfCondition

def generate_launch_description():
    sim_arg = DeclareLaunchArgument('simulated', default_value='True')
    pkg_cmd = get_package_share_directory('robmob_cmd_law')
    pkg_bringup = get_package_share_directory('robmob_bringup')
    
    config_planner = os.path.join(get_package_share_directory('rrt_connect_planner'), 'config', 'planner_node.yaml')
    config_cmd = os.path.join(get_package_share_directory('robmob_cmd_law'), 'config', 'cmd_law_node.yaml')

    # Nom de la carte que tu as sauvegard√©e manuellement
    map_name_arg = DeclareLaunchArgument(
        'map_name', 
        default_value='map_generee.yaml', 
        description='Nom du fichier yaml dans robmob_bringup/config'
    )

    # Chemin complet vers le fichier de carte
    map_config_path = PathJoinSubstitution([
        pkg_bringup, 'config', LaunchConfiguration('map_name')
    ])
    
    rviz_config_path = PathJoinSubstitution([
      pkg_bringup, 'rviz', 'custom.rviz'
    ])

    # Localisation et Map Server
    loc_launch = IncludeLaunchDescription(
        PathJoinSubstitution([
            get_package_share_directory('robmob_bringup'), 'launch', 'map_server_amcl.launch.py'
        ]),
        launch_arguments={
            'map_file': map_config_path,
            'use_sim_time': LaunchConfiguration('simulated')
        }.items()
    )

    planner_node = Node(
        package='rrt_connect_planner',
        executable='planner_node',
        name='rrt_planner_node',
        parameters=[config_planner, {'use_sim_time': LaunchConfiguration('simulated')}]
    )

    cmd_law_node = Node(
        package='robmob_cmd_law',
        executable='cmd_law_node',
        name='cmd_law_node',
        parameters=[config_cmd, {'use_sim_time': LaunchConfiguration('simulated')}]
    )
    
    gz_launch = IncludeLaunchDescription(
        PythonLaunchDescriptionSource(
            os.path.join(get_package_share_directory('turtlebot3_gazebo'), 'launch', 'turtlebot3_world.launch.py')
        ),
        condition=IfCondition(LaunchConfiguration('simulated'))
    )

    rviz_node = Node(
        package='rviz2',
        executable='rviz2',
        arguments=['-d', rviz_config_path],
        parameters=[{'use_sim_time': LaunchConfiguration('simulated')}],
        output='screen'
    )

    return LaunchDescription([
        sim_arg,
        map_name_arg,
        rviz_node,
        loc_launch,
        cmd_law_node,
        planner_node,
        gz_launch
    ])